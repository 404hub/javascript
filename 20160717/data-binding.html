<!DOCTYPE html>
<html>
<head>
	<title>data binding test</title>
</head>
<body>

	<div id="binding">
		{{name}}
		{{sex}}
		<br>
		{{haha}}
	</div>

	<script type="text/javascript">


		function dataBinding(obj) {
			this._el = obj.id || ''; 
			this._ready = obj.ready || function()ï½›};
			this._data = obj.data || {};

			this.dom = {};
			this.init = {};

			this.dom._context = document.getElementById(this._el);
			var variable = this.getVariable();
			this.renderStart(variable);

			this.arr = [1, 2, 3];

			return this;
		}

		dataBinding.prototype.renderStart = function(variable) {
			this.digestVariable(variable);
		};

		dataBinding.prototype.getVariable = function() {
			this.dom.innerHTML = this.dom._context.innerHTML;
			var re = /\{\{.*\}\}/g;
			var result = this.dom.innerHTML.match(re);
			for (var i = result.length - 1; i >= 0; i--) {
				result[i] = result[i].replace('{{', '');
				result[i] = result[i].replace('}}', '');
			};
			return result;
		};

		dataBinding.prototype.renderDOM = function(DOMRendered) {
			this.dom._context.innerHTML = DOMRendered;
		};

		dataBinding.prototype.makeDOM = function(dom, isChange) {

			isChange = isChange || false;

			this.dom.newerInnerHTML = '';

			for (var i = 0; i < this.dom.innerHTML.length; i++) {
				this.dom.newerInnerHTML += this.dom.innerHTML[i];					
			};

			console.log(dom, this.dom.newerInnerHTML);

			for (var i = 0; i < dom.length; i++) {

				if(!dom[i]) {
					continue;
				}

				var key = dom[i].key;
				var val = dom[i].val;

				this.dom.newerInnerHTML = this.dom.newerInnerHTML.replace('{{' + key + '}}', val);
			};

			this.renderDOM(this.dom.newerInnerHTML);
			if(!isChange) {
				this._ready();				
			}

		};

		dataBinding.prototype.digestVariable = function(variable) {

			var validVariable = [];
			var dom = [];

			for (var i = 0; i < variable.length; i++) {
				var currentVar = variable[i];
				var flag = false;
				var val = '';
				for(var key in this._data) {
					if(currentVar == key) {
						flag = true;
						val = this._data[currentVar];
					}
				}
				if(!flag) {
					throw 'variable ' + currentVar + ' is undefined';
				}else {
					dom.push({
						key: currentVar,
						val: val
					});

					this[currentVar] = val;
					this.watch(currentVar);
				}
			};

			this.init.dom = dom;
			this.makeDOM(dom);

			return validVariable;

		};

		dataBinding.prototype.watch = function(key) {

			var self = this;

			Object.defineProperty(self, key, {
				set: function(x, y) {

					var dataIndex = this.findIndexOfData({
						key: key,
						val: x
					})

					if(dataIndex != -1) {

						delete this.init.dom[dataIndex];

						this.init.dom.push({
							key: key,
							val: x
						});

						self.makeDOM(this.init.dom, true);
					}

				}
			});

		};

		dataBinding.prototype.findIndexOfData = function(data) {

			for (var i = 0; i < this.init.dom.length; i++) {
				var currentData = this.init.dom[i];
				if(data.key == currentData.key) {
					return i; 
				}
			};

			return -1;

		}


		var db = new dataBinding({
			id: 'binding',
			data: {
				name: 'test',
				sex: 'you',
				haha: '2333'
			},

			ready: function() {

				console.log('dom ready');

				console.log('change name');

				this.name = "my data binding";

			}
		});

	</script>

</body>
</html>